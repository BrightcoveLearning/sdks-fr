---
title: 'Ajout de paramètres de requête d'annonce avec les SDK natifs' la
description: Dans cette rubrique, vous apprendrez à ajouter des paramètres de requête publicitaire à vos URL VMAP avec les SDK Brightcove Native Player.
parent: Features 
grandparent: Home
---
 <h1>{{ page.title }}</h1>
<article class="bcls-article">
  <summary>{{ page.description }}</summary>

<section class="bcls-section">
<h2 id="Overview">Aperçu</h2>

<p>Même si les SDK du lecteur natif n'effectuent pas de remplacement de macro côté client, vous pouvez ajouter manuellement des paramètres de chaîne de requête pour le ciblage publicitaire. Cela peut être fait pour les annonces côté client ou côté serveur.</p>

<p>Pour en savoir plus sur les paramètres d'URL, consultez le <a href="https://ssai.support.brightcove.com/vod/guides/video-cloud-ssai-ad-config-api.html#Ad_variables">Variables publicitaires</a> section du document de l'API Video Cloud SSAI Ad Config.</p>
</section>

<section class="bcls-section">
<h2 id="Client_side_ads">Annonces côté client</h2>
<p>Vous pouvez fournir des valeurs personnalisées via des paramètres d'URL ajoutés à l'URL VMAP.</p>
<aside class="bcls-aside bcls-aside--information">L'ajout de paramètres de requête à une URL de tag d'emplacement publicitaire n'est possible qu'avec les annonces Google IMA. Google IMA est le seul fournisseur d'annonces qui expose l'URL de la balise d'annonce à cette fin ; d'autres fournisseurs d'annonces, tels que FreeWheel et Pulse, fournissent un ensemble de paramètres de configuration.</aside>

<h3>Implémentation Android</h3>
<p>Les paires clé/valeur de ciblage des annonces peuvent être ajoutées à l'URL de votre tag d'emplacement publicitaire de deux manières :</p>
<ul>
  <li>
    Ajoutez vos paires clé/valeur directement à l'URL du tag d'emplacement publicitaire. Google IMA permet l'ajout de paires clé/valeur de ciblage publicitaire à l'aide de la <code translate="No">cust_params</code> paramètre. Pour plus de détails, voir Google <a href="https://support.google.com/admanager/answer/1080597">Ajouter des valeurs-clés à un tag de redirection vidéo maître</a> document.
  </li>
  <li>
    Appliquez une carte de valeurs à l'URL du tag d'emplacement publicitaire à l'aide de la <code translate="No">updateAdTargetingValues</code> méthode pour le <code translate="No">GoogleIMAComponent</code>.
  </li>
</ul>
<p>Quelle que soit l'approche, les paires clé/valeur sont ajoutées à l'URL du tag d'emplacement publicitaire dans le <code translate="No">ADS_REQUEST_FOR_VIDEO</code> écouteur d'événement. L'exemple de code ci-dessous ajoute les paires clé/valeur en utilisant le <code translate="No">updateAdTargetingValues</code> méthode pour le <code translate="No">GoogleIMAComponent</code>.</p>

<p>Voici le code pour créer une carte de paires clé/valeur, en utilisant le <code translate="No">CUSTOM_FIELDS</code> propriété de la <code translate="No">Video</code> propriété d'objet du <code translate="No">ADS_REQUEST_FOR_VIDEO</code> un événement:</p>
<pre>
<code class="language-swift" translate="No">Video video = (Video) event.getProperties().get(Event.VIDEO);
if (video != null) {
    Map&lt;String, String&gt; customFieldsMap = (HashMap&lt;String, String&gt;) video.getProperties().get(Video.Fields.CUSTOM_FIELDS);
}
</code></pre>

<p>Voici un exemple de code complet pour le <code translate="No">ADS_REQUEST_FOR_VIDEO</code> l'écouteur d'événement, qui est ajouté à la méthode de configuration du plug-in Google IMA :</p>
<pre>
<code class="language-swift" translate="No">eventEmitter.on(GoogleIMAEventType.ADS_REQUEST_FOR_VIDEO, event -&gt; {
    // Create a container object for the ads to be presented.
    AdDisplayContainer container = sdkFactory.createAdDisplayContainer();
    container.setPlayer(googleIMAComponent.getVideoAdPlayer());
    container.setAdContainer(brightcoveVideoView);
    // Build an ads request object and point it to the ad
    // display container created above.
    AdsRequest adsRequest = sdkFactory.createAdsRequest();

    // Set Ad Targeting values, using the Video object's Custom Fields
    // (if they are present; if they are not present, use default values instead) 
    Video video = (Video) event.getProperties().get(Event.VIDEO);
    if (video != null) {
        Map&lt;String, String&gt; customFieldsMap = (HashMap&lt;String, String&gt;) video.getProperties().get(Video.Fields.CUSTOM_FIELDS);
        if (customFieldsMap != null) { 
            googleIMAComponent.updateAdTargetingValues(customFieldsMap);
        }
    }

    adsRequest.setAdTagUrl(adRulesURL);
    adsRequest.setAdDisplayContainer(container);
    ArrayList&lt;AdsRequest&gt; adsRequests = new ArrayList&lt;AdsRequest&gt;(1);
    adsRequests.add(adsRequest);
    // Respond to the event with the new ad requests.
    event.properties.put(GoogleIMAComponent.ADS_REQUESTS, adsRequests);
    eventEmitter.respond(event);
});
</code></pre>

<h3>Implémentation iOS</h3>
<p>Pour ajouter des paramètres de requête publicitaire avec le SDK natif pour iOS, procédez comme suit :</p>
<ol class="bcls-tasklist-restart">
	<li>
	<p>Commencez avec l'un des exemples de code côté client pour la publicité IMA avec le Brightcove Native SDK :</p>

	<ul>
		<li><a href="https://github.com/BrightcoveOS/ios-player-samples">Exemples de lecteur iOS</a></li>
	</ul>
	</li>
	<li>
	<p>Ajoutez les paramètres de requête d'URL à l'URL VMAP avant d'appeler le plug-in IMA. Cela peut être fait avant les méthodes suivantes :</p>

	<pre>
<code class="language-objectivec" translate="No">for video in mutablePlaylist.videos {
  if let _video = video as? BCOVMutableVideo {
     _video.properties[kBCOVIMAAdTag] = IMAConfig.VMAPResponseAdTag
    updatedVideos.append(_video)
  }
}</code></pre>
	</li>
</ol>
</section>

<section class="bcls-section">
<h2 id="Server_side_ads">Annonces côté serveur</h2>

<p>Pour fournir des valeurs personnalisées via les paramètres d'URL ajoutés à l'URL VMAP, procédez comme suit :</p>

<ol class="bcls-tasklist-restart">
	<li>
	<p>Avec un identifiant de configuration d'annonce SSAI, récupérez un objet vidéo du catalogue Brightcove (API de lecture). Découvrez comment créer une configuration d'annonce avec le <a href="/features/implementing-server-side-ads-native-player-sdks.html#Create_an_ad_configuration">Implémentation des publicités côté serveur avec les SDK Native Player</a> document.</p>

	<p>Voici un exemple de configuration d'annonce :</p>

	<pre class="line-numbers">
<code class="language-swift" translate="No">{
  "name": "SSAI VMAP Ad Server",
  "vmap_response_namespace": "bc",
  "config_id": "<span class="bcls-input">your ad config Id</span>",
  "account_id": "1752604059001",
  "created_timestamp": "2017-10-24T20:21:55.106488973Z",
  "updated_timestamp": "2017-10-26T14:26:22.161791419Z",
  "ad_config": {
  	"enable_ads": true,
  	"expected_ad_response": "dfp_vmap",
  	"proxy_beacons_enabled": false,
  	"template_url": {
  		"template": "https://solutions.brightcove.com/bcls/brightcove-player/vmap/simple-vmap.xml"
  	}
  }
}</code></pre>

	<aside class="bcls-aside bcls-aside--tip">Les <code translate="No">template_url</code> La propriété contient l'URL de l'annonce.</aside>
	</li>
	<li>
	<p>Dans le jsonResponse de l'appel à l'API de lecture, examinez les sources de l'objet vidéo. Chaque objet source contiendra une propriété VMAP et une URL VMAP. Sélectionnez et extrayez l'URL VMAP.</p>

	<pre>
<code class="language-swift" translate="No">http://ssaiplayback.prod.boltdns.net/playback/once/v1/vmap/hls/v3/clear/3981276734001/
  b871a6b8-4b3e-4787-b176-aed923287d5a/477b1308-fc18-47a6-bb99-6cb9e2ff2040/
  content.vmap<span class="bcls-highlight">?bc_token=XXX</span></code></pre>

	<aside class="bcls-aside bcls-aside--tip">Le seul paramètre d'URL sur l'URL VMAP sera le <code translate="No">bc_token</code>.</aside>
	</li>
	<li>
	<p>Imaginons que l'URL de votre annonce ressemble à ceci :</p>

	<pre>
<code class="language-swift" translate="No">https://myad.com/ads?rule={{url.rule}}&amp;id={{url.video.id}}</code></pre>

	<p>Si votre URL d'annonce contient les macros d'annonces ci-dessus, vous ajouterez ces paramètres de requête aux URL VMAP avec les valeurs appropriées.</p>
	</li>
	<li>
	<p>Ajoutez les paramètres de requête à l'URL VMAP. Dans cet exemple, le <code translate="No">{{url.rule}}</code> la macro dans l'URL de l'annonce est remplacée par la valeur <code translate="No">discos-enabled</code> , et le <code translate="No">{{url.video_id}}</code> la macro est remplacée par la valeur de l'identifiant vidéo.</p>

	<pre>
<code class="language-swift" translate="No">http://ssaiplayback.prod.boltdns.net/playback/once/v1/vmap/hls/v3/clear/3981276734001/
b871a6b8-4b3e-4787-b176-aed923287d5a/477b1308-fc18-47a6-bb99-6cb9e2ff2040/
content.vmap<span class="bcls-highlight">?bc_token=XXX&amp;rule=discos-enabled&amp;video_id=5625751316001</span></code></pre>
	</li>
	<li>Traitez la vidéo avec le plugin SSAI.</li>
	<li>
	<p>Pour plus de détails sur le développement, voir ce qui suit :</p>

	<ul>
		<li><a href="#Android_implementation">Implémentation Android</a></li>
		<li><a href="#iOS_implementation">Implémentation iOS</a></li>
	</ul>
	</li>
</ol>

<h3 id="Android_implementation">Implémentation Android</h3>

<p>À partir de la réponse de l'API de lecture, vous pouvez extraire l'URL source VMAP appropriée et ajouter vos paramètres de requête. Pour le faire, suivez ces étapes:</p>

<ol class="bcls-tasklist-restart">
	<li>Avec un identifiant de configuration d'annonce SSAI, récupérez un objet vidéo du catalogue Brightcove (API de lecture). Pour plus de détails, consultez le <a href="/features/implementing-server-side-ads-native-player-sdks.html#Android_implementation">Implémentation Android</a> section du document Implémentation des publicités côté serveur avec les SDK du lecteur natif.</li>
  <li>
    <p>
      Dans le <code translate="No">Catalog</code>'s <code translate="No">onVideo</code> méthode de rappel, sélectionnez et extrayez l'URL VMAP appropriée du <code translate="No">Video</code> la source par défaut de l'objet, en utilisant le <code translate="No">SSAISourceSelector</code>. L'objet source renvoyé doit avoir une propriété URL VMAP.
    </p>
    <pre>
<code class="language-swift" translate="No">SSAISourceSelector sourceSelector = new SSAISourceSelector();
Source source = sourceSelector.selectSource(video);            
String vmapUrl = source.getStringProperty(Source.Fields.VMAP);</code></pre>
  </li>
  <li>
    <p>
      Ajoutez vos paramètres de requête à l'URL VMAP :
    </p>
    <pre>
<code class="language-swift" translate="No">private String configureVmapUrlWithCustomParams(String vmapUrl, Map&lt;String, String&gt; vmapUrlParams) {
    Uri.Builder vmapBuilder = Uri.parse(vmapUrl).buildUpon();
    for (Map.Entry&lt;String, String&gt; entry : vmapUrlParams.entrySet()) {
        vmapBuilder.appendQueryParameter(entry.getKey(), entry.getValue());
    }
    return vmapBuilder.toString();
}</code></pre>
  </li>
  <li>
    <p>
      Traiter la mise à jour <code translate="No">Video</code> object avec le plugin SSAI comme suit :
    </p>
    <pre>
<code class="language-swift" translate="No">plugin.processVideo(video);</code></pre>
  </li>
</ol>
<p>Voici un exemple de code complet :</p>
<pre>
<code class="language-swift" translate="No">HttpRequestConfig httpRequestConfig = new HttpRequestConfig.Builder()
        .addQueryParameter(AD_CONFIG_ID_QUERY_PARAM_KEY, AD_CONFIG_ID_QUERY_PARAM_VALUE)
        .build();
Map&lt;String, String&gt; vmapUrlParams = new HashMap&lt;&gt;();
vmapUrlParams.put(&quot;section&quot;, &quot;sports&quot;);
vmapUrlParams.put(&quot;multi&quot;, &quot;baseball,tennis&quot;);

catalog.findVideoByID(getString(R.string.video_id), httpRequestConfig, new VideoListener() {
    @Override public void onVideo(Video video) {
        // The Video Sources will have a VMAP url which will be processed by the SSAI plugin,
        // If there is not a VMAP url, or if there are any requesting or parsing error,
        // an EventType.ERROR event will be emitted.
        try{
            SSAISourceSelector sourceSelector = new SSAISourceSelector();
            Source source = sourceSelector.selectSource(video);
            String vmapUrl = source.getStringProperty(Source.Fields.VMAP);
            source.getProperties().put(Source.Fields.VMAP, configureVmapUrlWithCustomParams(vmapUrl, vmapUrlParams)); plugin.processVideo(video);
        }
        catch (NoSourceFoundException ns) {
            Log.e(TAG, &quot;No usable source was found - &quot; + ns.getMessage());
        }
    }
});

private String configureVmapUrlWithCustomParams(String vmapUrl, Map&lt;String, String&gt; vmapUrlParams) {
    Uri.Builder vmapBuilder = Uri.parse(vmapUrl).buildUpon();
    for (Map.Entry&lt;String, String&gt; entry : vmapUrlParams.entrySet()) {
        vmapBuilder.appendQueryParameter(entry.getKey(), entry.getValue());
    }
    return vmapBuilder.toString();
}</code></pre>

<h3 id="iOS_implementation">Implémentation iOS</h3>

<p>À partir de la réponse de l'API de lecture, vous pouvez extraire l'URL source VMAP appropriée et ajouter vos paramètres de requête. Pour le faire, suivez ces étapes:</p>

<ol class="bcls-tasklist-restart">
	<li>Avec un identifiant de configuration d'annonce SSAI, récupérez un objet vidéo du catalogue Brightcove (API de lecture). Pour plus de détails, consultez le <a href="/features/implementing-server-side-ads-native-player-sdks.html#iOS_implementation">Implémentation iOS</a> section du document Implémentation des publicités côté serveur avec les SDK du lecteur natif.</li>
	<li>
	<p>À partir de l'objet vidéo, sélectionnez et extrayez le manifeste ou l'URL VMAP approprié. À partir de la réponse du service de lecture, le jsonResponse (NSDictionary) contient le <a href="/ios/reference/sdk/Classes/BCOVVideo.html">BCOVVidéo</a> objet, qui inclut les sources qui contiennent l'URL du document VMAP. Votre code peut ressembler à ceci :</p>

	<pre>
<code class="language-swift" translate="No">// Create a mutable version of the jsonResponse NSDictionary object
NSURLComponents *components = [[NSURLComponents alloc] init];
NSMutableDictionary *videoPropertiesDictionary = [[NSMutableDictionary alloc] init];
NSMutableArray *updatedSources = [[NSMutableArray alloc] init];

// Define the URL parameters that will be added to the VMAP URL
NSURLQueryItem *queryItemEntrypointUrlParameter = [NSURLQueryItem queryItemWithName:@"rule" value:@"discos-enabled"];
NSURLQueryItem *queryItemVideoId = [NSURLQueryItem queryItemWithName:@"video_id" value:jsonResponse[@"id"]];

//deserialize the video and store in dictionary
[videoPropertiesDictionary addEntriesFromDictionary:jsonResponse];</code></pre>
	</li>
	<li>
	<p>Ajoutez les paramètres de requête à l'URL VMAP.</p>

	<pre class="line-numbers">
<code class="language-swift" translate="No">// For each source, update each VMAP URL stored in the jsonResponse NSDictionary object and assemble the NSURLQueryItem. Store it in the mutable version of the jsonResponse NSDictionary object.
for (NSDictionary *source in videoPropertiesDictionary[@"sources"])
{
    NSMutableDictionary *mutableSource = [[NSMutableDictionary alloc] init];
    [mutableSource addEntriesFromDictionary:source];

    NSString *vmapURL = mutableSource[@"vmap"];
    components = [NSURLComponents componentsWithString:vmapURL];

    NSArray *queryItemsArray = components.queryItems;
    NSURLQueryItem *bctoken = [queryItemsArray firstObject];
    components.queryItems = @[bctoken, queryItemEntrypointUrlParameter, queryItemVideoId ];
    mutableSource[@"vmap"] = components.URL.absoluteString;

    [updatedSources addObject:mutableSource];
}</code></pre>
	</li>
	<li>
	<p>Traitez l'URL modifiée avec le plug-in SSAI comme suit :</p>

	<pre class="line-numbers">
<code class="language-swift" translate="No">videoPropertiesDictionary[@"sources"] = updatedSources;
// Create a new video object with the updated jsonResponse NSDictionary object
BCOVVideo *video = [BCOVPlaybackService videoFromJSONDictionary:videoPropertiesDictionary];
// Setting this video object to the BCOVPlaybackController will call the new vmap URL (with the URL parameters appended) when playback starts.
[self.controller setVideos:@[video]];</code></pre>
	<!-- <p>For a complete code example, expand the <strong>iOS ViewController using Objective-C</strong> section below.</p> --></li>
</ol>
<!-- <details>
    <summary><h2 id="iOS_ViewController_using_Objective-C">iOS ViewController using Objective-C</h2></summary>
<p>Your <strong>ViewController.m</strong> file should look similar to this:</p>

<pre class="line-numbers">
<code class="language-objectivec" translate="No">//
//  ViewController.m
//  SSAI Params
//
//  Copyright © 2018 Brightcove. All rights reserved.
//

#import "ViewController.h"

@import BrightcovePlayerSDK;
@import BrightcoveOUX;

// ** Customize these values with your own account information **
NSString *accountId = @"<span class="bcls-input">your account Id</span>";
NSString *policyKey = @"<span class="bcls-input">your policy key</span>";
NSString *videoId = @"<span class="bcls-input">your video Id</span>";
NSString *adConfigId = @"<span class="bcls-input">your ad configuration Id</span>";

@interface ViewController () &lt;BCOVPlaybackControllerDelegate&gt;

@property (nonatomic, strong) id&lt;BCOVPlaybackController&gt; playbackController;
@property (nonatomic, strong) BCOVPlaybackService *playbackService;
@property (nonatomic) BCOVPUIPlayerView *playerView;
@property (weak, nonatomic) IBOutlet UIView *videoContainerView;
@property (weak, nonatomic) IBOutlet UIView *companionSlotContainerView;
@property(copy) NSArray&lt;NSURLQueryItem *&gt; *queryItems;

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.

    BCOVPlayerSDKManager *manager = [BCOVPlayerSDKManager sharedManager];

    // Create a companion slot.
    BCOVOUXCompanionSlot *companionSlot = [[BCOVOUXCompanionSlot alloc] initWithView:self.companionSlotContainerView width:500 height:61];

    // In order to display an ad progress banner on the top of the view, we create this display container.  This object is also responsible for populating the companion slots.
    BCOVOUXAdComponentDisplayContainer *adComponentDisplayContainer = [[BCOVOUXAdComponentDisplayContainer alloc] initWithCompanionSlots:@[companionSlot]];

    self.controller = [manager createOUXPlaybackControllerWithViewStrategy:nil];

    // In order for the ad display container to receive ad information, we add it as a session consumer.
    [self.controller addSessionConsumer:adComponentDisplayContainer];

    self.controller.delegate = self;
    self.controller.autoPlay = YES;
    self.controller.autoAdvance = YES;

    BCOVPUIBasicControlView *controlView = [BCOVPUIBasicControlView basicControlViewWithVODLayout];
    // Set playback controller later.
    self.playerView = [[BCOVPUIPlayerView alloc] initWithPlaybackController:nil options:nil controlsView:controlView];

    [self.videoContainerView addSubview:self.playerView];
    self.playerView.translatesAutoresizingMaskIntoConstraints = NO;
    [NSLayoutConstraint activateConstraints:@[
        [self.playerView.topAnchor constraintEqualToAnchor:self.videoContainerView.topAnchor],
        [self.playerView.rightAnchor constraintEqualToAnchor:self.videoContainerView.rightAnchor],
        [self.playerView.leftAnchor constraintEqualToAnchor:self.videoContainerView.leftAnchor],
        [self.playerView.bottomAnchor constraintEqualToAnchor:self.videoContainerView.bottomAnchor],
    ]];

    self.playerView.playbackController = self.controller;

    _playbackService = [[BCOVPlaybackService alloc]
                        initWithAccountId:accountId
                        policyKey:policyKey];

    [self requestContentFromPlaybackService];
}

- (void)requestContentFromPlaybackService
{
	// Set your SSAI ad configuration id as a query parameter
  NSDictionary *queryParameters = @{
                                    @"ad_config_id" : kViewControllerAdConfigID
                                    };
  // Retrieve a video from the Playback API using a video Id and your ad config Id
  [self.playbackService findVideoWithVideoID:videoId parameters:queryParameters completion:^(BCOVVideo *video, NSDictionary *jsonResponse, NSError *error) {

    if (video)
    {
      // Create a mutable version of the jsonResponse NSDictionary object
      NSURLComponents *components = [[NSURLComponents alloc] init];
      NSMutableDictionary *videoPropertiesDictionary = [[NSMutableDictionary alloc] init];
      NSMutableArray *updatedSources = [[NSMutableArray alloc] init];

			// Define the URL parameters that will be added to the VMAP URL
      NSURLQueryItem *queryItemEntrypointUrlParameter = [NSURLQueryItem queryItemWithName:@"rule" value:@"discos-enabled"];
      NSURLQueryItem *queryItemVideoId = [NSURLQueryItem queryItemWithName:@"video_id" value:jsonResponse[@"id"]];

      //deserialize the video and store in dictionary
      [videoPropertiesDictionary addEntriesFromDictionary:jsonResponse];

      // For each source, update each VMAP URL stored in the jsonResponse NSDictionary object
      // and assemble the NSURLQueryItem. Store it in the mutable version of the jsonResponse NSDictionary object.
      for (NSDictionary *source in videoPropertiesDictionary[@"sources"])
      {
        NSMutableDictionary *mutableSource = [[NSMutableDictionary alloc] init];
        [mutableSource addEntriesFromDictionary:source];

        NSString *vmapURL = mutableSource[@"vmap"];
        components = [NSURLComponents componentsWithString:vmapURL];

        NSArray *queryItemsArray = components.queryItems;
        NSURLQueryItem *bctoken = [queryItemsArray firstObject];
        components.queryItems = @[bctoken, queryItemEntrypointUrlParameter, queryItemVideoId ];
        mutableSource[@"vmap"] = components.URL.absoluteString;

        [updatedSources addObject:mutableSource];
      }
      videoPropertiesDictionary[@"sources"] = updatedSources;
      // Create a new video object with the updated jsonResponse NSDictionary object
      BCOVVideo *video = [BCOVPlaybackService videoFromJSONDictionary:videoPropertiesDictionary];
      // Setting this video object to the BCOVPlaybackController will call the new vmap URL
      // (with the URL parameters appended) when playback starts.
      [self.controller setVideos:@[video]];
    }
    else
    {
      NSLog(@"ViewController Debug - Error retrieving video playlist: `%@`", error);
    }

  }];
}

@end</code></pre>
</details> -->
</section>
</article>